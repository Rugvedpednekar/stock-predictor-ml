<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockPredictor - Search</title>

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981',
                        'secondary': '#1f2937',
                        'background': '#0f172a',
                        'text-light': '#f3f4f6',
                        'red-alert': '#ef4444',
                        'green-success': '#10b981',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        #stock-chart {
            background-color: #1f2937;
            border-radius: 12px;
            width: 100%;
            height: 400px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: #10b981;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body class="bg-background text-text-light font-sans">

<!-- NAVBAR -->
<header class="bg-secondary shadow-lg sticky top-0 z-10">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
        <a href="{{ url_for('index') }}" class="text-2xl font-bold text-primary">
            StockPredictor 
        </a>
        <nav class="hidden md:flex gap-6 text-lg">
            <a href="{{ url_for('index') }}" class="hover:text-primary">Home</a>
            <a href="{{ url_for('search_page') }}" class="text-primary font-semibold">Search</a>
            <a href="{{ url_for('how_page') }}" class="hover:text-primary">How It Works</a>
        </nav>
    </div>
</header>

<main class="min-h-screen py-16">
    <div class="container mx-auto px-6 max-w-4xl">

        <h2 class="text-3xl font-bold mb-6 text-center">Search for a Stock</h2>
        <p class="text-center text-gray-400 mb-10">
            Type a <span class="font-mono">ticker</span> (AAPL, TSLA) or company name (Apple, Amazon).
            Choose a <span class="font-mono">time range</span>, and optionally enable live refresh.
        </p>

        <!-- Search bar + suggestions -->
        <div class="bg-secondary p-4 rounded-xl border border-gray-700 mb-4 relative">
            <div class="flex flex-col sm:flex-row gap-4">
                <input id="search-ticker"
                       type="text"
                       placeholder="Start typing: AAPL, Apple, Amazon..."
                       class="flex-grow px-4 py-3 bg-gray-800 rounded-xl text-text-light border border-gray-600
                              focus:outline-none focus:ring-2 focus:ring-primary">
                <button onclick="searchStock()"
                        class="bg-primary px-6 py-3 rounded-xl text-background font-bold hover:bg-green-600">
                    View Stock
                </button>
            </div>

            <!-- Suggestions dropdown -->
            <div id="suggestions"
                 class="absolute left-0 right-0 mt-2 bg-gray-900 border border-gray-700 rounded-xl shadow-xl max-h-60 overflow-y-auto hidden z-20">
            </div>
        </div>

        <!-- Time range + live controls -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
            <div class="flex flex-wrap gap-2">
                <button id="btn-1mo"  onclick="setPeriod('1mo')"  class="px-3 py-1 rounded-full text-sm border border-gray-600 hover:border-primary">1M</button>
                <button id="btn-3mo"  onclick="setPeriod('3mo')"  class="px-3 py-1 rounded-full text-sm border border-gray-600 hover:border-primary">3M</button>
                <button id="btn-6mo"  onclick="setPeriod('6mo')"  class="px-3 py-1 rounded-full text-sm border border-primary bg-primary/20">6M</button>
                <button id="btn-1y"   onclick="setPeriod('1y')"   class="px-3 py-1 rounded-full text-sm border border-gray-600 hover:border-primary">1Y</button>
                <button id="btn-2y"   onclick="setPeriod('2y')"   class="px-3 py-1 rounded-full text-sm border border-gray-600 hover:border-primary">2Y</button>
            </div>

            <button id="live-toggle"
                    onclick="toggleLive()"
                    class="px-4 py-1.5 rounded-full text-sm border border-green-success text-green-success hover:bg-green-success/10">
                ðŸ”´ Live Off
            </button>
        </div>

        <!-- Results Card -->
        <div id="stock-details-card" class="hidden bg-secondary p-6 rounded-2xl border border-gray-700">

            <!-- Ticker row -->
            <div class="flex justify-between items-center pb-4 border-b border-gray-700 mb-6">
                <div>
                    <h3 id="display-ticker" class="text-3xl font-bold">--</h3>
                    <p id="display-name" class="text-gray-400 text-sm">ML Forecasted Stock</p>
                    <p id="display-period" class="text-gray-500 text-xs mt-1"></p>
                </div>
                <div class="text-right">
                    <p id="current-price" class="text-4xl font-bold">$0.00</p>
                    <p id="current-change" class="text-red-alert text-lg font-semibold">(0.00 / 0.00%)</p>
                </div>
            </div>

            <!-- History Chart -->
            <h4 class="text-xl font-bold mb-3 text-primary">Price History</h4>
            <canvas id="stock-chart"></canvas>

            <!-- ML PREDICTION -->
            <div class="bg-gray-800 p-5 rounded-xl mt-6">
                <h5 class="text-xl font-semibold mb-4 text-primary">ML Prediction Forecast</h5>

                <button id="predict-button" onclick="predictStock()"
                        class="w-full bg-red-alert hover:bg-red-600 py-3 rounded-xl font-bold flex items-center justify-center gap-3">
                    RUN PREDICTION
                </button>

                <div id="prediction-output" class="hidden p-4 rounded-xl border border-gray-700 mt-4">
                    <p id="prediction-status" class="text-sm mb-2"></p>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-900 p-3 rounded-lg">
                            <p class="text-xs text-gray-400">Predicted Price</p>
                            <p id="predicted-price" class="text-2xl font-bold text-green-success">$0.00</p>
                        </div>
                        <div class="bg-gray-900 p-3 rounded-lg">
                            <p class="text-xs text-gray-400">Model Confidence</p>
                            <p id="model-confidence" class="text-2xl font-bold text-yellow-400">0%</p>
                        </div>
                    </div>
                </div>

                <p class="text-xs text-gray-500 mt-3">
                    Note: Confidence is a heuristic and does not represent real-world probability.
                </p>
            </div>
        </div>

        <p id="search-initial-message" class="text-center text-gray-400 mt-10">
            Enter a stock symbol or company name above to begin.
        </p>
    </div>
</main>

<!-- FOOTER -->
<footer class="text-center text-gray-400 py-6 border-t border-gray-800">
    Â© Rugved Pednekar
</footer>

<script>
    function formatCurrency(n) {
        return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(n);
    }

    let currentTickerData = null;
    let currentPeriod = "6mo";  // default
    let currentSymbol = null;
    let liveIntervalId = null;
    const LIVE_INTERVAL_MS = 30000; // 30 seconds

    // Small static universe of popular stocks for suggestions / name lookup
    const STOCKS = [
        { symbol: "AAPL", name: "Apple Inc." },
        { symbol: "AMZN", name: "Amazon.com, Inc." },
        { symbol: "GOOGL", name: "Alphabet Inc. (Class A)" },
        { symbol: "GOOG", name: "Alphabet Inc. (Class C)" },
        { symbol: "MSFT", name: "Microsoft Corporation" },
        { symbol: "META", name: "Meta Platforms, Inc." },
        { symbol: "TSLA", name: "Tesla, Inc." },
        { symbol: "NFLX", name: "Netflix, Inc." },
        { symbol: "NVDA", name: "NVIDIA Corporation" },
        { symbol: "AMD", name: "Advanced Micro Devices, Inc." },
        { symbol: "INTC", name: "Intel Corporation" },
        { symbol: "JPM", name: "JPMorgan Chase & Co." },
        { symbol: "BAC", name: "Bank of America Corporation" },
        { symbol: "V", name: "Visa Inc." },
        { symbol: "MA", name: "Mastercard Incorporated" },
        { symbol: "DIS", name: "The Walt Disney Company" },
        { symbol: "WMT", name: "Walmart Inc." }
    ];

    const inputEl = document.getElementById("search-ticker");
    const suggBox = document.getElementById("suggestions");

    // --- Autocomplete logic ---
    inputEl.addEventListener("input", () => {
        const query = inputEl.value.trim().toLowerCase();
        if (!query) {
            suggBox.classList.add("hidden");
            suggBox.innerHTML = "";
            return;
        }

        const matches = STOCKS.filter(stock =>
            stock.symbol.toLowerCase().includes(query) ||
            stock.name.toLowerCase().includes(query)
        ).slice(0, 8);

        if (matches.length === 0) {
            suggBox.classList.add("hidden");
            suggBox.innerHTML = "";
            return;
        }

        suggBox.innerHTML = matches.map(stock => `
            <button type="button"
                    class="w-full text-left px-4 py-2 hover:bg-gray-800 flex justify-between items-center"
                    onclick="selectSuggestion('${stock.symbol}')">
                <span>
                    <span class="font-semibold">${stock.symbol}</span>
                    <span class="text-gray-400 text-sm ml-2">${stock.name}</span>
                </span>
            </button>
        `).join("");

        suggBox.classList.remove("hidden");
    });

    document.addEventListener("click", (e) => {
        if (!suggBox.contains(e.target) && e.target !== inputEl) {
            suggBox.classList.add("hidden");
        }
    });

    function selectSuggestion(symbol) {
        inputEl.value = symbol;
        suggBox.classList.add("hidden");
        suggBox.innerHTML = "";
        searchStock();
    }

    function resolveToTicker(raw) {
        const q = raw.trim().toLowerCase();
        if (!q) return "";

        const bySymbol = STOCKS.find(s => s.symbol.toLowerCase() === q);
        if (bySymbol) return bySymbol.symbol;

        const byNameExact = STOCKS.find(s => s.name.toLowerCase() === q);
        if (byNameExact) return byNameExact.symbol;

        const byNamePartial = STOCKS.find(s => s.name.toLowerCase().includes(q));
        if (byNamePartial) return byNamePartial.symbol;

        return raw.toUpperCase();
    }

    function setPeriod(p) {
        currentPeriod = p;
        highlightPeriodButton(p);
        if (currentSymbol) {
            fetchAndRenderCurrent();
        }
    }

    function highlightPeriodButton(active) {
        const periods = ["1mo", "3mo", "6mo", "1y", "2y"];
        periods.forEach(p => {
            const btn = document.getElementById(`btn-${p}`);
            if (!btn) return;
            if (p === active) {
                btn.classList.add("border-primary", "bg-primary/20");
                btn.classList.remove("border-gray-600");
            } else {
                btn.classList.remove("border-primary", "bg-primary/20");
                btn.classList.add("border-gray-600");
            }
        });
    }

    function toggleLive() {
        const btn = document.getElementById("live-toggle");
        if (liveIntervalId) {
            clearInterval(liveIntervalId);
            liveIntervalId = null;
            btn.textContent = "ðŸ”´ Live Off";
            btn.classList.remove("bg-green-success/10");
        } else {
            if (!currentSymbol) {
                alert("Search for a stock first.");
                return;
            }
            liveIntervalId = setInterval(fetchAndRenderCurrent, LIVE_INTERVAL_MS);
            btn.textContent = "ðŸŸ¢ Live On (30s)";
            btn.classList.add("bg-green-success/10");
        }
    }

    async function searchStock() {
        let rawInput = inputEl.value;
        if (!rawInput.trim()) return;

        const ticker = resolveToTicker(rawInput);
        currentSymbol = ticker;

        document.getElementById("search-initial-message").classList.add("hidden");
        await fetchAndRenderCurrent();
    }

    async function fetchAndRenderCurrent() {
        if (!currentSymbol) return;

        try {
            const res = await fetch(`/predict?symbol=${encodeURIComponent(currentSymbol)}&period=${encodeURIComponent(currentPeriod)}`);
            if (!res.ok) {
                alert("Server error or invalid symbol.");
                return;
            }

            const data = await res.json();
            currentTickerData = data;

            document.getElementById("stock-details-card").classList.remove("hidden");

            document.getElementById("display-ticker").textContent = data.symbol || currentSymbol;
            document.getElementById("display-name").textContent = "ML Forecasted Stock";
            document.getElementById("display-period").textContent = `Time range: ${data.period || currentPeriod}`;

            document.getElementById("current-price").textContent = formatCurrency(data.current_price);

            const change = data.predicted_next_close - data.current_price;
            const pct = (change / data.current_price) * 100;

            const changeElem = document.getElementById("current-change");
            changeElem.textContent = `(${change.toFixed(2)} / ${pct.toFixed(2)}%)`;
            changeElem.className =
                "text-lg font-semibold " + (change >= 0 ? "text-green-success" : "text-red-alert");

            updatePredictionPanel();
            renderChart(data.history);

        } catch (err) {
            console.error(err);
            alert("Something went wrong. Please try again.");
        }
    }

    function updatePredictionPanel() {
        const data = currentTickerData;
        if (!data) return;

        document.getElementById("prediction-output").classList.remove("hidden");
        document.getElementById("predicted-price").textContent = formatCurrency(
            data.predicted_next_close
        );

        const changePct = Math.abs((data.predicted_next_close - data.current_price) / data.current_price * 100);
        const conf = Math.min(95, 50 + changePct * 1.5);

        document.getElementById("model-confidence").textContent = conf.toFixed(1) + "%";
        document.getElementById("prediction-status").innerHTML =
            `Model says <b>${data.signal}</b>: ${data.message}`;
    }

    async function predictStock() {
        await fetchAndRenderCurrent();
    }

    function renderChart(history) {
        if (!history || !history.length) return;

        const canvas = document.getElementById("stock-chart");
        const ctx = canvas.getContext("2d");

        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;

        ctx.fillStyle = "#1f2937";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const prices = history.map(h => h.close);
        const min = Math.min(...prices);
        const max = Math.max(...prices);
        if (max === min) return;

        ctx.strokeStyle = "#10b981";
        ctx.lineWidth = 2;
        ctx.beginPath();

        prices.forEach((p, i) => {
            const x = (i / (prices.length - 1)) * canvas.width;
            const y = canvas.height - ((p - min) / (max - min)) * canvas.height;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });

        ctx.stroke();
    }
</script>

</body>
</html>


